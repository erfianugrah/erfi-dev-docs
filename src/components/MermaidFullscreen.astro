---
/**
 * MermaidFullscreen Component
 * GitHub-style fullscreen modal for Mermaid diagrams
 * Simple click-to-expand with zoom controls
 */
---

<script>
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initMermaidFullscreen);
  } else {
    initMermaidFullscreen();
  }

  function initMermaidFullscreen() {
    const mermaidSvgs = document.querySelectorAll('svg[id^="mermaid-"]');

    mermaidSvgs.forEach((svgElement) => {
      if (svgElement.hasAttribute('data-fullscreen-ready')) return;
      svgElement.setAttribute('data-fullscreen-ready', 'true');

      // Wrap SVG
      const wrapper = document.createElement('div');
      wrapper.className = 'mermaid-diagram-wrapper';
      svgElement.parentNode?.insertBefore(wrapper, svgElement);
      wrapper.appendChild(svgElement);

      // Add expand button
      const expandBtn = createExpandButton();
      wrapper.appendChild(expandBtn);

      // Click handlers
      const openFullscreen = () => {
        const modal = createModal(svgElement);
        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden';

        // Focus trap
        setTimeout(() => {
          modal.querySelector('button')?.focus();
        }, 100);
      };

      expandBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        openFullscreen();
      });

      svgElement.addEventListener('click', openFullscreen);
      svgElement.style.cursor = 'zoom-in';
      svgElement.setAttribute('role', 'button');
      svgElement.setAttribute('aria-label', 'Click to view diagram fullscreen');
      svgElement.setAttribute('tabindex', '0');

      // Keyboard support
      svgElement.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          openFullscreen();
        }
      });
    });
  }

  function createExpandButton() {
    const btn = document.createElement('button');
    btn.className = 'mermaid-expand-btn';
    btn.setAttribute('aria-label', 'Expand diagram');
    btn.innerHTML = `<svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
      <path d="M1.5 1a.5.5 0 0 0-.5.5v4a.5.5 0 0 1-1 0v-4A1.5 1.5 0 0 1 1.5 0h4a.5.5 0 0 1 0 1h-4zM10 .5a.5.5 0 0 1 .5-.5h4A1.5 1.5 0 0 1 16 1.5v4a.5.5 0 0 1-1 0v-4a.5.5 0 0 0-.5-.5h-4a.5.5 0 0 1-.5-.5zM.5 10a.5.5 0 0 1 .5.5v4a.5.5 0 0 0 .5.5h4a.5.5 0 0 1 0 1h-4A1.5 1.5 0 0 1 0 14.5v-4a.5.5 0 0 1 .5-.5zm15 0a.5.5 0 0 1 .5.5v4a1.5 1.5 0 0 1-1.5 1.5h-4a.5.5 0 0 1 0-1h4a.5.5 0 0 0 .5-.5v-4a.5.5 0 0 1 .5-.5z"/>
    </svg>`;
    return btn;
  }

  function createModal(svgElement: Element) {
    const modal = document.createElement('div');
    modal.className = 'mermaid-modal';
    modal.setAttribute('role', 'dialog');
    modal.setAttribute('aria-modal', 'true');

    const container = document.createElement('div');
    container.className = 'mermaid-modal-container';

    // Close button
    const closeBtn = document.createElement('button');
    closeBtn.className = 'mermaid-modal-close';
    closeBtn.setAttribute('aria-label', 'Close');
    closeBtn.innerHTML = '×';

    // Zoom controls
    const controls = document.createElement('div');
    controls.className = 'mermaid-modal-controls';

    const zoomIn = document.createElement('button');
    zoomIn.className = 'mermaid-zoom-btn';
    zoomIn.setAttribute('aria-label', 'Zoom in');
    zoomIn.textContent = '+';

    const zoomOut = document.createElement('button');
    zoomOut.className = 'mermaid-zoom-btn';
    zoomOut.setAttribute('aria-label', 'Zoom out');
    zoomOut.textContent = '−';

    const zoomReset = document.createElement('button');
    zoomReset.className = 'mermaid-zoom-btn';
    zoomReset.setAttribute('aria-label', 'Reset zoom');
    zoomReset.textContent = '1:1';

    controls.appendChild(zoomOut);
    controls.appendChild(zoomReset);
    controls.appendChild(zoomIn);

    // Diagram container
    const diagramContainer = document.createElement('div');
    diagramContainer.className = 'mermaid-modal-diagram';

    const svgClone = svgElement.cloneNode(true) as SVGElement;
    // Override any cursor styling from the SVG
    svgClone.style.cursor = 'grab';
    diagramContainer.appendChild(svgClone);

    container.appendChild(closeBtn);
    container.appendChild(controls);
    container.appendChild(diagramContainer);
    modal.appendChild(container);

    // State
    let scale = 1;
    let translateX = 0;
    let translateY = 0;
    let isDragging = false;
    let startX = 0;
    let startY = 0;

    const updateTransform = () => {
      svgClone.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
      const cursor = isDragging ? 'grabbing' : 'grab';
      svgClone.style.cursor = cursor;
      diagramContainer.style.cursor = cursor;
    };

    // Zoom controls
    zoomIn.addEventListener('click', () => {
      scale = Math.min(scale * 1.2, 5);
      updateTransform();
    });

    zoomOut.addEventListener('click', () => {
      scale = Math.max(scale / 1.2, 0.5);
      updateTransform();
    });

    zoomReset.addEventListener('click', () => {
      scale = 1;
      translateX = 0;
      translateY = 0;
      updateTransform();
    });

    // Mouse wheel zoom
    diagramContainer.addEventListener('wheel', (e) => {
      e.preventDefault();
      const delta = e.deltaY > 0 ? 0.9 : 1.1;
      scale = Math.min(Math.max(scale * delta, 0.5), 5);
      updateTransform();
    }, { passive: false });

    // Drag to pan - works at any zoom level
    diagramContainer.addEventListener('mousedown', (e) => {
      // Only start drag if clicking on the diagram container, not buttons
      if (e.target !== diagramContainer && e.target !== svgClone) return;

      isDragging = true;
      startX = e.clientX - translateX;
      startY = e.clientY - translateY;
      e.preventDefault();
      updateTransform();
    });

    const handleMouseMove = (e: MouseEvent) => {
      if (!isDragging) return;
      translateX = e.clientX - startX;
      translateY = e.clientY - startY;
      updateTransform();
    };

    const handleMouseUp = () => {
      if (isDragging) {
        isDragging = false;
        updateTransform();
      }
    };

    // Add listeners to window for better drag behavior
    window.addEventListener('mousemove', handleMouseMove);
    window.addEventListener('mouseup', handleMouseUp);

    // Touch support
    let initialDistance = 0;
    let initialScale = 1;

    diagramContainer.addEventListener('touchstart', (e) => {
      if (e.touches.length === 2) {
        // Pinch to zoom
        initialDistance = Math.hypot(
          e.touches[0].clientX - e.touches[1].clientX,
          e.touches[0].clientY - e.touches[1].clientY
        );
        initialScale = scale;
      } else if (e.touches.length === 1) {
        // Drag to pan
        isDragging = true;
        startX = e.touches[0].clientX - translateX;
        startY = e.touches[0].clientY - translateY;
      }
    });

    diagramContainer.addEventListener('touchmove', (e) => {
      e.preventDefault();

      if (e.touches.length === 2) {
        // Pinch to zoom
        const distance = Math.hypot(
          e.touches[0].clientX - e.touches[1].clientX,
          e.touches[0].clientY - e.touches[1].clientY
        );
        scale = Math.min(Math.max(initialScale * (distance / initialDistance), 0.5), 5);
        updateTransform();
      } else if (e.touches.length === 1 && isDragging) {
        // Drag to pan
        translateX = e.touches[0].clientX - startX;
        translateY = e.touches[0].clientY - startY;
        updateTransform();
      }
    }, { passive: false });

    diagramContainer.addEventListener('touchend', () => {
      isDragging = false;
      updateTransform();
    });

    // Close handlers
    const closeModal = () => {
      modal.classList.add('closing');
      // Clean up event listeners
      window.removeEventListener('mousemove', handleMouseMove);
      window.removeEventListener('mouseup', handleMouseUp);
      setTimeout(() => {
        document.body.removeChild(modal);
        document.body.style.overflow = '';
      }, 200);
    };

    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });

    const escHandler = (e: KeyboardEvent) => {
      if (e.key === 'Escape') {
        closeModal();
        document.removeEventListener('keydown', escHandler);
      }
    };
    document.addEventListener('keydown', escHandler);

    // Show with animation
    setTimeout(() => modal.classList.add('active'), 10);

    return modal;
  }
</script>

<style is:global>
  .mermaid-diagram-wrapper {
    position: relative;
    display: block;
    background: var(--sl-color-gray-6);
    border-radius: 0.5rem;
    padding: 1rem;
    margin: 1.5rem 0;
    transition: box-shadow 0.2s;
  }

  :root[data-theme='dark'] .mermaid-diagram-wrapper {
    background: var(--sl-color-gray-5);
  }

  .mermaid-diagram-wrapper:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .mermaid-diagram-wrapper svg {
    display: block;
    max-width: 100%;
    height: auto;
    transition: opacity 0.2s;
  }

  .mermaid-diagram-wrapper:hover svg {
    opacity: 0.9;
  }

  .mermaid-expand-btn {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    background: var(--sl-color-bg);
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.25rem;
    padding: 0.5rem;
    cursor: pointer;
    opacity: 0;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    color: var(--sl-color-text);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .mermaid-diagram-wrapper:hover .mermaid-expand-btn {
    opacity: 1;
  }

  .mermaid-expand-btn:hover {
    background: var(--sl-color-accent);
    color: white;
    border-color: var(--sl-color-accent);
    transform: scale(1.05);
  }

  /* Modal */
  .mermaid-modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.9);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .mermaid-modal.active {
    opacity: 1;
  }

  .mermaid-modal.closing {
    opacity: 0;
  }

  .mermaid-modal-container {
    position: relative;
    width: 90vw;
    height: 90vh;
    background: var(--sl-color-bg);
    border-radius: 0.5rem;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .mermaid-modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 0.25rem;
    border: 1px solid var(--sl-color-gray-5);
    background: var(--sl-color-bg);
    color: var(--sl-color-text);
    font-size: 1.5rem;
    line-height: 1;
    cursor: pointer;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .mermaid-modal-close:hover {
    background: var(--sl-color-red);
    color: white;
    border-color: var(--sl-color-red);
  }

  .mermaid-modal-controls {
    position: absolute;
    bottom: 1rem;
    right: 1rem;
    display: flex;
    gap: 0.5rem;
    z-index: 10;
  }

  .mermaid-zoom-btn {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 0.25rem;
    border: 1px solid var(--sl-color-gray-5);
    background: var(--sl-color-bg);
    color: var(--sl-color-text);
    font-size: 1.25rem;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .mermaid-zoom-btn:hover {
    background: var(--sl-color-accent);
    color: white;
    border-color: var(--sl-color-accent);
  }

  .mermaid-modal-diagram {
    flex: 1;
    overflow: auto;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 4rem 2rem 2rem;
  }

  .mermaid-modal-diagram {
    cursor: grab;
    user-select: none;
  }

  .mermaid-modal-diagram:active {
    cursor: grabbing;
  }

  .mermaid-modal-diagram svg {
    display: block;
    max-width: none;
    max-height: none;
    width: auto;
    height: auto;
    transition: transform 0.1s ease-out;
    transform-origin: center center;
    /* Ensure smooth vector rendering at all scales */
    shape-rendering: geometricPrecision;
    text-rendering: geometricPrecision;
    /* Override any cursor from SVG elements */
    cursor: grab !important;
  }

  .mermaid-modal-diagram svg * {
    cursor: inherit !important;
  }

  .mermaid-modal-diagram:active svg {
    cursor: grabbing !important;
  }

  @media (max-width: 50rem) {
    .mermaid-modal-container {
      width: 100vw;
      height: 100vh;
      border-radius: 0;
    }

    .mermaid-modal-controls {
      bottom: 0.5rem;
      right: 0.5rem;
    }
  }
</style>
